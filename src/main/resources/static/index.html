<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syncfusion Collaborative Editing Demo</title>

    <!-- Syncfusion CSS -->
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-base/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-buttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-dropdowns/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-inputs/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-navigations/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-popups/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-lists/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-splitbuttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-layouts/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-notifications/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-documenteditor/styles/bootstrap5.css" rel="stylesheet">

    <!-- SockJS and STOMP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!-- Syncfusion JS -->
    <script src="https://cdn.syncfusion.com/ej2/26.2.7/dist/ej2.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2196F3;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .user-info {
            font-size: 14px;
        }
        .editor-container {
            flex: 1;
            overflow: hidden;
        }
        #documenteditor {
            height: 100%;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.connected {
            background: #4CAF50;
        }
        .status.disconnected {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div>
                <h1>Collaborative Document Editing</h1>
                <span style="font-size: 12px;">Room ID: {{ roomId }}</span>
            </div>
            <div class="user-info">
                User: {{ currentUser }}
                <span class="status" :class="connected ? 'connected' : 'disconnected'">
                    {{ connected ? 'Connected' : 'Disconnected' }}
                </span>
            </div>
        </div>
        <div class="editor-container">
            <div id="documenteditor"></div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    serviceUrl: 'http://localhost:8098/',
                    webSocketEndPoint: 'http://localhost:8098/ws',
                    currentUser: '',
                    roomId: '',
                    connectionId: '',
                    connected: false,
                    container: null,
                    stompClient: null
                }
            },
            mounted() {
                this.initializeUser();
                this.initializeRoomId();
                this.initializeEditor();
                this.loadDocument();
            },
            methods: {
                initializeUser() {
                    const users = ['Alice Smith', 'Bob Johnson', 'Carol Williams', 'David Brown', 'Emma Davis'];
                    const random = Math.floor(Math.random() * users.length);
                    this.currentUser = users[random];
                },

                initializeRoomId() {
                    const urlParams = new URLSearchParams(window.location.search);
                    let roomId = urlParams.get('roomId');

                    if (!roomId) {
                        roomId = Math.random().toString(36).substring(2, 15);
                        window.history.replaceState({}, '', `?roomId=${roomId}`);
                    }

                    this.roomId = roomId;
                },

                initializeEditor() {
                    const toolbarItems = [
                        'Undo', 'Redo', 'Separator',
                        'Image', 'Table', 'Hyperlink', 'Bookmark', 'Separator',
                        'Header', 'Footer', 'PageSetup', 'Separator',
                        'Find', 'Separator'
                    ];

                    this.container = new ej.documenteditor.DocumentEditorContainer({
                        height: '100%',
                        toolbarItems: toolbarItems,
                        enableToolbar: true,
                        currentUser: this.currentUser
                    });

                    // Don't set serviceUrl for collaborative editing - we use the collaborative endpoints instead
                    // this.container.serviceUrl = this.serviceUrl + 'api/wordeditor/';
                    ej.documenteditor.DocumentEditorContainer.Inject(ej.documenteditor.Toolbar);
                    this.container.appendTo('#documenteditor');

                    // Inject collaborative editing module
                    ej.documenteditor.DocumentEditor.Inject(ej.documenteditor.CollaborativeEditingHandler);
                    this.container.documentEditor.enableCollaborativeEditing = true;

                    // Handle content changes
                    this.container.contentChange = (args) => {
                        if (this.container.documentEditor.collaborativeEditingHandlerModule) {
                            this.container.documentEditor.collaborativeEditingHandlerModule.sendActionToServer(args.operations);
                        }
                    };
                },

                loadDocument() {
                    fetch(this.serviceUrl + 'api/collaborativeediting/ImportFile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fileName: 'sample.docx',
                            roomName: this.roomId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.openDocument(data);
                    })
                    .catch(error => {
                        alert('Failed to load document. Make sure you have uploaded sample.docx to MinIO.');
                    });
                },

                openDocument(data) {
                    // Update the room and version information
                    this.container.documentEditor.collaborativeEditingHandlerModule.updateRoomInfo(
                        this.roomId,
                        data.version || 0,
                        this.serviceUrl + 'api/collaborativeediting/'
                    );

                    // Pass SFDT as JSON string to open method
                    this.container.documentEditor.open(data);
                    this.container.documentEditor.documentName = 'Collaborative Document';

                    // Connect to WebSocket
                    setTimeout(() => {
                        this.initializeWebSocket();
                    }, 100);
                },

                initializeWebSocket() {
                    const ws = new SockJS(this.webSocketEndPoint);
                    this.stompClient = Stomp.over(ws);

                    this.stompClient.connect({}, () => {
                        this.onConnected();
                    }, (error) => {
                        this.connected = false;
                    });
                },

                onConnected() {
                    this.connected = true;

                    // Subscribe to room topic
                    this.stompClient.subscribe('/topic/public/' + this.roomId, (message) => {
                        this.onDataReceived(message);
                    });

                    // Join the room
                    this.connectToRoom();
                },

                connectToRoom() {
                    const userInfo = {
                        currentUser: this.currentUser,
                        version: 0,
                        roomName: this.roomId,
                        connectionId: ''
                    };

                    this.stompClient.send(
                        '/app/join/' + this.roomId,
                        {},
                        JSON.stringify(userInfo)
                    );
                },

                onDataReceived(message) {
                    if (!this.container.documentEditor.collaborativeEditingHandlerModule) {
                        return;
                    }

                    const content = JSON.parse(message.body);
                    const action = content.headers['action'];
                    const payload = content.payload;

                    if (payload.operations != null) {
                        // Apply remote edit operation
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('action', payload);
                    } else if (action === 'removeUser') {
                        // User left
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('removeUser', payload.connectionId);
                    } else if (action === 'connectionId' && this.connectionId === '') {
                        // Store connection ID
                        this.connectionId = payload.connectionId;
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('connectionId', payload.connectionId);
                    } else if (Array.isArray(payload)) {
                        // Users list updated
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
