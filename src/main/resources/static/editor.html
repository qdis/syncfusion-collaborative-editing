<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Document Editor</title>

    <!-- Syncfusion CSS -->
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-base/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-buttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-dropdowns/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-inputs/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-navigations/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-popups/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-lists/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-splitbuttons/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-layouts/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-notifications/styles/bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/26.2.7/ej2-documenteditor/styles/bootstrap5.css" rel="stylesheet">

    <!-- SockJS and STOMP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!-- Syncfusion JS -->
    <script src="https://cdn.syncfusion.com/ej2/26.2.7/dist/ej2.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .header-info h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .header-info .filename {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 2px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-info {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.connected {
            background: #4CAF50;
        }
        .status.disconnected {
            background: #f44336;
        }
        .connected-users {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
        }
        .editor-container {
            flex: 1;
            overflow: hidden;
        }
        #documenteditor {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-left">
                <button class="back-btn" @click="goBack">‚Üê Back to Files</button>
                <div class="header-info">
                    <h1>Collaborative Document Editor</h1>
                    <div class="filename">{{ fileName }}</div>
                </div>
            </div>
            <div class="header-right">
                <div class="connected-users">
                    üë• {{ connectedUsers }} user{{ connectedUsers !== 1 ? 's' : '' }} online
                </div>
                <div class="user-info">
                    <span>{{ currentUser }}</span>
                    <span class="status" :class="connected ? 'connected' : 'disconnected'">
                        {{ connected ? 'Connected' : 'Disconnected' }}
                    </span>
                </div>
            </div>
        </div>
        <div class="editor-container">
            <div id="documenteditor"></div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    serviceUrl: window.location.origin + '/',
                    webSocketEndPoint: window.location.origin + '/ws',
                    currentUser: 'Loading...',
                    roomId: '',
                    fileName: '',
                    connectionId: '',
                    connected: false,
                    connectedUsers: 0,
                    container: null,
                    stompClient: null
                }
            },
            mounted() {
                this.initializeRoomId();
                this.getCurrentUser();
            },
            methods: {
                getCurrentUser() {
                    fetch('/api/files/currentUser')
                        .then(response => response.json())
                        .then(data => {
                            this.currentUser = data.username;
                            this.initializeEditor();
                            this.loadDocument();
                        })
                        .catch(err => {
                            console.error('Failed to fetch current user:', err);
                            this.currentUser = 'User';
                            this.initializeEditor();
                            this.loadDocument();
                        });
                },

                initializeRoomId() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.roomId = urlParams.get('roomId');

                    if (!this.roomId) {
                        alert('No room ID specified');
                        window.location.href = '/files.html';
                        return;
                    }

                    // Decode base64 to get filename
                    try {
                        this.fileName = atob(this.roomId);
                    } catch (e) {
                        alert('Invalid room ID');
                        window.location.href = '/files.html';
                    }
                },

                goBack() {
                    window.location.href = '/files.html';
                },

                initializeEditor() {
                    const toolbarItems = [
                        'Undo', 'Redo', 'Separator',
                        'Image', 'Table', 'Hyperlink', 'Bookmark', 'Separator',
                        'Header', 'Footer', 'PageSetup', 'Separator',
                        'Find', 'Separator'
                    ];

                    this.container = new ej.documenteditor.DocumentEditorContainer({
                        height: '100%',
                        toolbarItems: toolbarItems,
                        enableToolbar: true,
                        currentUser: this.currentUser
                    });

                    ej.documenteditor.DocumentEditorContainer.Inject(ej.documenteditor.Toolbar);
                    this.container.appendTo('#documenteditor');

                    // Inject collaborative editing module
                    ej.documenteditor.DocumentEditor.Inject(ej.documenteditor.CollaborativeEditingHandler);
                    this.container.documentEditor.enableCollaborativeEditing = true;

                    // Handle content changes
                    this.container.contentChange = (args) => {
                        if (this.container.documentEditor.collaborativeEditingHandlerModule) {
                            this.container.documentEditor.collaborativeEditingHandlerModule.sendActionToServer(args.operations);
                        }
                    };
                },

                loadDocument() {
                    fetch(this.serviceUrl + 'api/collaborativeediting/ImportFile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fileName: this.fileName,
                            roomName: this.roomId
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load document');
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.openDocument(data);
                    })
                    .catch(error => {
                        console.error('Error loading document:', error);
                        alert('Failed to load document: ' + error.message);
                    });
                },

                openDocument(data) {
                    // Update the room and version information
                    this.container.documentEditor.collaborativeEditingHandlerModule.updateRoomInfo(
                        this.roomId,
                        data.version || 0,
                        this.serviceUrl + 'api/collaborativeediting/'
                    );

                    // Open the document
                    this.container.documentEditor.open(data);
                    this.container.documentEditor.documentName = this.fileName;

                    // Connect to WebSocket
                    setTimeout(() => {
                        this.initializeWebSocket();
                    }, 100);
                },

                initializeWebSocket() {
                    const ws = new SockJS(this.webSocketEndPoint);
                    this.stompClient = Stomp.over(ws);

                    this.stompClient.connect({}, () => {
                        this.onConnected();
                    }, (error) => {
                        console.error('WebSocket connection error:', error);
                        this.connected = false;
                    });
                },

                onConnected() {
                    this.connected = true;

                    // Subscribe to room topic
                    this.stompClient.subscribe('/topic/public/' + this.roomId, (message) => {
                        this.onDataReceived(message);
                    });

                    // Join the room
                    this.connectToRoom();
                },

                connectToRoom() {
                    const userInfo = {
                        currentUser: this.currentUser,
                        version: 0,
                        roomName: this.roomId,
                        connectionId: ''
                    };

                    this.stompClient.send(
                        '/app/join/' + this.roomId,
                        {},
                        JSON.stringify(userInfo)
                    );
                },

                onDataReceived(message) {
                    if (!this.container.documentEditor.collaborativeEditingHandlerModule) {
                        return;
                    }

                    const content = JSON.parse(message.body);
                    const action = content.headers['action'];
                    const payload = content.payload;

                    if (payload.operations != null) {
                        // Apply remote edit operation
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('action', payload);
                    } else if (action === 'removeUser') {
                        // User left
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('removeUser', payload.connectionId);
                        this.connectedUsers = Math.max(0, this.connectedUsers - 1);
                    } else if (action === 'connectionId' && this.connectionId === '') {
                        // Store connection ID and update current user from server
                        this.connectionId = payload.connectionId;
                        if (payload.currentUser) {
                            this.currentUser = payload.currentUser;
                        }
                        this.container.documentEditor.collaborativeEditingHandlerModule.applyRemoteAction('connectionId', payload.connectionId);
                    } else if (action === 'addUser' && Array.isArray(payload)) {
                        // Users list updated
                        this.connectedUsers = payload.length;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
